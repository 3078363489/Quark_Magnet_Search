{% extends "base.html" %}
{% block title %}{{ article.title }} - {{ Site_Information.Site_title }}{% endblock %}
{% block keywords %}
{{ article.tags.all|join:"," }}{% if article.tags.all %}{% else %} {% endif %}
{% endblock %}
{% load custom_filters %}
{% block description %}{{ article.content|striptags|remove_all_whitespace|truncate_chinese_chars:40 }}{% endblock %}
{% block extra_head %}
<style>
    /* 夸克资源下载区域样式 */
    .quark-download-card {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
    }

    .quark-download-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #ff6b6b, #ff8e53);
    }

    .quark-download-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
    }

    .download-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-bottom: 15px;
    }

    .download-header i {
        font-size: 1.8rem;
        color: #ff8a00;
    }

    .download-title {
        font-size: 1.3rem;
        color: #ffffff;
        margin: 0;
    }

    .quark-btn {
        background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
        color: white;
        border: none;
        padding: 15px 25px;
        border-radius: 50px;
        font-size: 1.1rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        width: 100%;
        justify-content: center;
        margin: 15px 0;
        position: relative;
        overflow: hidden;
    }

    .quark-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: all 0.6s ease;
    }

    .quark-btn:hover::before {
        left: 100%;
    }

    .quark-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .quark-btn:active {
        transform: translateY(-1px);
    }

    .quark-btn:disabled {
        background: #9e9e9e;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .tags-container {
        margin-top: 15px;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
    }

    .resource-tag {
        display: inline-block;
        background: rgba(255, 255, 255, 0.1);
        padding: 5px 12px;
        border-radius: 20px;
        margin: 4px;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }

    .resource-tag:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }
    .resource-tag a {
      text-decoration: none;
      color: inherit;
    }

    /* 修复布局问题 */
    .resource-content {
        display: grid;
        grid-template-columns: 1fr;
        gap: 25px;
        align-items: start;
    }

    .resource-main {
        min-width: 0;
        order: 2;
    }

    .resource-sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
        order: 1;
    }

    /* 资源头部样式 */
    .resource-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 25px;
        padding: 15px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 12px;
    }

    .resource-icon {
        font-size: 2.5rem;
        color: #ff8a00;
    }

    .resource-title {
        font-size: 1.5rem;
        margin: 0 0 10px 0;
        color: #fff;
    }

    .resource-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
    }

    .category-badge {
        background: rgba(255, 138, 0, 0.2);
        padding: 4px 10px;
        border-radius: 15px;
        color: #ff8a00;
    }

    .file-size, .file-date {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    /* 主要内容布局 */


        .resource-main {
            order: 1; /* 移动端优先：文章内容在上 */
        }

        .resource-sidebar {
            order: 2; /* 移动端优先：下载区域在下 */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

    /* 资源描述样式 */
    .resource-description {
        margin-bottom: 25px;
    }

    .resource-description h3 {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #fff;
        margin-bottom: 15px;
    }

    .Post-body {
        background: rgba(0, 0, 0, 0.1);
        padding: 20px;
        border-radius: 12px;
        line-height: 1.6;
    }

    /* 相关资源样式 */
    .related-resources {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        padding: 20px;
    }

    .related-resources h3 {
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #fff;
    }

    .related-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .related-list li {
        margin-bottom: 10px;
    }

    .related-list a {
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .related-list a:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
    }

    /* 资源统计样式 */
    .resource-stats {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        padding: 20px;
    }

    .resource-stats h3 {
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #fff;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .stat-item {
        text-align: center;
        padding: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #ff8a00;
    }

    .stat-label {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
    }

    /* 模态框样式 */
    .quark-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        backdrop-filter: blur(5px);
    }

    .modal-content {
        background: white;
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        max-width: 90%;
        width: 350px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        animation: modalAppear 0.3s ease;
    }

    @keyframes modalAppear {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-title {
        font-size: 1.4rem;
        margin-bottom: 20px;
        color: #333;
    }

    .modal-qr {
        display: block;
        margin: 0 auto 20px;
        width: 180px;
        height: 180px;
        border: 1px solid #eee;
    }

    .modal-text {
        margin-bottom: 20px;
        color: #666;
        font-size: 0.95rem;
    }

    .modal-button {
        padding: 10px 20px;
        background: #ff6b6b;
        color: white;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .modal-button:hover {
        background: #ff8e53;
    }

    /* 平板和桌面设备样式 */
    @media (min-width: 768px) {
        .resource-content {
            grid-template-columns: 1fr 350px;
        }

        .resource-main {
            order: 1;
        }

        .resource-sidebar {
            order: 2;
            position: sticky;
            top: 20px;
        }

        .resource-title {
            font-size: 1.8rem;
        }
    }

    /* 超大屏幕设备样式 */
    @media (min-width: 1200px) {
        .resource-content {
            gap: 30px;
        }
    }

    /* 小屏幕手机特殊适配 */
     @media (max-width: 360px) {
        .resource-header {
            flex-direction: column;
            text-align: center;
        }

        .resource-meta {
            justify-content: center;
        }

        .quark-btn {
            padding: 12px 20px;
            font-size: 1rem;
        }

        .download-header i {
            font-size: 1.5rem;
        }

        .download-title {
            font-size: 1.2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<section class="resource-detail-section">
    <div class="resource-header">
        <div class="resource-icon">
            <i class="fas fa-{{ article_type.Font_Awesome_Web }}"></i>
        </div>
        <div class="resource-info">
            <h1 class="resource-title">{{ article.title }}</h1>
            <div class="resource-meta">
                <span class="category-badge">{{ article_type.type }}</span>
                <span class="file-size"><i class="fas fa-eye"></i>{{ article.view_count }}</span>
                <span class="file-date"><i class="fas fa-calendar"></i> {{ article.Create_date|date:'Y-m-d H:i' }}</span>
            </div>
        </div>
    </div>

    <div class="resource-content">
        <div class="resource-main">
            <div class="resource-description">
                <h3><i class="fas fa-file-alt"></i>资源描述</h3>
                <div class="Post-body">
                    {{ article.content|safe }}
                </div>
            </div>
        </div>

        <div class="resource-sidebar">
            <!-- 夸克下载区域 -->
            <div class="quark-download-card">
                <div class="download-header">
                    <i class="fas fa-download"></i>
                    <h3 class="download-title">资源下载</h3>
                </div>
                {% if article.state %}
                    <button class="quark-btn" id="quarkDownloadBtn"
                    data-download-url="{{article.link}}"
                    data-article-id="{{article.id}}">
                    <i class="fas fa-cloud-download-alt"></i> 夸克资源下载
                    </button>
                {% else %}
                    <button class="quark-btn" disabled>
                    <i class="fas fa-cloud-download-alt"></i> 链接已失效
                    </button>
                {% endif %}
                <div class="tags-container">
                    {% for tag in article.tags.all %}
                    <span class="resource-tag"><a href="/search/?q={{ tag.tag }}">{{ tag.tag }}</a></span>
                    {% endfor %}
                </div>
            </div>

            {% if related_articles %}
            <div class="related-resources">
                <h3><i class="fas fa-link"></i> 相关资源</h3>
                <ul class="related-list">
                    {% for related in related_articles %}
                    <li>
                        <a href="{% url 'detail' article_id=related.id %}">
                            <i class="fas fa-{{ article_type.Font_Awesome_Web }}"></i> {{ related.title }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <div class="resource-stats">
                <h3><i class="fas fa-chart-bar"></i> 资源统计</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">{{ Downloads.Total_Downloads }}</div>
                        <div class="stat-label">总下载</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ Downloads.Weekly_Downloads }}</div>
                        <div class="stat-label">周下载</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<!-- 夸克下载功能的内联脚本 -->
<script>
function setupQuarkDownload() {
    const quarkBtn = document.getElementById('quarkDownloadBtn');
    if (!quarkBtn) return;

    // 检测设备类型
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // 获取Cookie
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    // 发送增量下载请求
    function incrementDownload(articleId) {
        fetch('/increment-download/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({article_id: articleId})
        })
        .then(response => {
            if (!response.ok) throw new Error('网络响应不正常');
            return response.json();
        })
        .then(data => {
            console.log('下载量已记录:', data);
        })
        .catch(error => {
            console.error('记录下载量失败:', error);
        });
    }

    // 检查模态框是否存在
    function modalExists() {
        return document.querySelector('.quark-modal');
    }

    // 移除模态框
    function removeExistingModal() {
        const existingModal = document.querySelector('.quark-modal');
        if (existingModal) document.body.removeChild(existingModal);
    }

    // 显示错误消息
    function showError(message) {
        // 先移除现有模态框
        removeExistingModal();

        const modal = document.createElement('div');
        modal.className = 'quark-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        `;

        const errorContainer = document.createElement('div');
        errorContainer.style.cssText = `
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        `;

        const title = document.createElement('h3');
        title.textContent = '下载出错';
        title.style.margin = '0 0 20px 0';
        title.style.color = '#d9534f';

        const errorMsg = document.createElement('p');
        errorMsg.textContent = message;
        errorMsg.style.margin = '0 0 20px 0';
        errorMsg.style.color = '#333';

        const closeBtn = document.createElement('button');
        closeBtn.textContent = '关闭';
        closeBtn.style.cssText = `
            margin-top: 10px;
            padding: 10px 25px;
            background: #f0f0f0;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        `;
        closeBtn.onmouseover = () => closeBtn.style.background = '#e0e0e0';
        closeBtn.onmouseout = () => closeBtn.style.background = '#f0f0f0';
        closeBtn.onclick = () => removeExistingModal();

        errorContainer.appendChild(title);
        errorContainer.appendChild(errorMsg);
        errorContainer.appendChild(closeBtn);
        modal.appendChild(errorContainer);
        document.body.appendChild(modal);

        modal.onclick = (e) => {
            if (e.target === modal) removeExistingModal();
        };
    }

    // 获取夸克存储链接
    function getQuarkStorageLink(quarkLink, articleId) {
        return new Promise((resolve, reject) => {
            fetch('/quark/qurak_storage/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    Quark_link: quarkLink,
                    network_id: articleId
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络请求失败: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    reject(data.error);
                } else if (data.link) {
                    resolve(data.link);
                } else if (data.message) {
                    reject(data.message);
                } else {
                    reject('未知错误: 没有返回有效链接');
                }
            })
            .catch(error => {
                reject(error.message || '网络请求异常');
            });
        });
    }

    // 显示二维码
    function showQRCode(url) {
        removeExistingModal();

        const modal = document.createElement('div');
        modal.className = 'quark-modal';

        const modalContent = document.createElement('div');
        modalContent.className = 'modal-content';

        const title = document.createElement('h3');
        title.className = 'modal-title';
        title.textContent = '扫码下载';

        const qrImg = document.createElement('img');
        qrImg.className = 'modal-qr';
        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
        qrImg.alt = '下载二维码';

        // 二维码加载失败处理
        qrImg.onerror = function() {
            this.src = `https://api.pwmqr.com/qrcode/create/?url=${encodeURIComponent(url)}`;
            this.onerror = function() {
                this.src = `https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=${encodeURIComponent(url)}`;
                this.onerror = function() {
                    const errorText = document.createElement('p');
                    errorText.textContent = '二维码生成失败，请手动访问链接';
                    errorText.style.color = 'red';
                    errorText.style.margin = '15px 0 0';
                    modalContent.appendChild(errorText);
                };
            };
        };

        const hint = document.createElement('p');
        hint.className = 'modal-text';
        hint.textContent = '使用夸克APP扫码下载';

        const closeBtn = document.createElement('button');
        closeBtn.className = 'modal-button';
        closeBtn.textContent = '关闭';
        closeBtn.onclick = () => removeExistingModal();

        modalContent.appendChild(title);
        modalContent.appendChild(qrImg);
        modalContent.appendChild(hint);
        modalContent.appendChild(closeBtn);
        modal.appendChild(modalContent);
        document.body.appendChild(modal);

        modal.onclick = (e) => {
            if (e.target === modal) removeExistingModal();
        };
    }

    // 按钮点击事件处理
    quarkBtn.addEventListener('click', async function() {
        const btn = this;
        const quarkLink = btn.dataset.downloadUrl;
        const articleId = btn.dataset.articleId || '';
        const originalHTML = btn.innerHTML;

        if (!quarkLink) {
            showError('下载链接未配置!');
            return;
        }

        // 保存原始按钮状态
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 获取中...';
        btn.disabled = true;

        try {
            // 获取夸克存储链接
            const downloadUrl = await getQuarkStorageLink(quarkLink, articleId);

            // 发送增量下载请求
            incrementDownload(articleId);

            // 根据设备类型处理
            if (isMobileDevice()) {
                // 手机端：直接跳转
                window.location.href = downloadUrl;
            } else {
                // 电脑端：显示二维码
                if (!modalExists()) {
                    showQRCode(downloadUrl);
                }
            }
        } catch (error) {
            console.error('下载出错:', error);
            showError(error);
        } finally {
            // 恢复按钮状态
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }, 2000);
        }
    });

    // 添加键盘事件支持
    quarkBtn.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            this.click();
        }
    });
}

// 确保DOM加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    setupQuarkDownload();
});
</script>
{% endblock %}